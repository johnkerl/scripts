#!/usr/bin/ruby

# ==============================================================================
# John Kerl sometime in the mid-200x's?
# http://johnkerl.org
# Ported to Ruby 2012-07-11.
# Runs a command a specifed number of times, e.g.
# repeat 20 'my-random-number-generator | md5sum'
# ==============================================================================

$us = File.basename $0

# ------------------------------------------------------------------------------
def usage()
   $stderr.puts " Usage: #{$us} {count} {command ...}"
   exit 1
end

# ------------------------------------------------------------------------------
$stdout.sync = true
$stderr.sync = true

usage unless ARGV.length >= 2;
usage unless ARGV[0] =~ /^[0-9]+$/
count = ARGV.shift.to_i;
usage unless count > 0;
cmd = ARGV.join(' ')

(1..count).each do |i|
   rc = system(cmd)
   status = $?

   if status.signaled? and status.termsig == 2
      # E.g. control-C.  Note that maybe a child process of system()
      # got the control-C, so we might not get it here.
      exit 1
   end
end
